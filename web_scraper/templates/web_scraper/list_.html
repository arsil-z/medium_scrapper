<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
  <script type="text/javascript">

</script>
<body>
<form method="POST">
	{% csrf_token %}
	<input id="search_query" type="text" name="search_query">
	<button id="get-articles" type="submit">Search </button>
</form>

<div id="article-div" class="article-div">
	<p></p>
</div>
</body>
</html>

<script>

	function getToken(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    var csrftoken = getToken('csrftoken');
	function reqListener() {
		console.log("Registered");}

	function updateProgress(oE) {
		let p = document.createElement('p');
		p.innerHTML = oE.target.responseText;
		document.getElementById("article-div").appendChild(p);
	}


	document.getElementById("get-articles").addEventListener("click", (e) => {
		e.preventDefault();
		var xmlhttp = new XMLHttpRequest();

		url = "{% url 'article_list_view_streaming' %}"
		xmlhttp.onload = () => {
			let data = xmlhttp.response
		}
		const searched_value = getQuery()
		const sendData = JSON.stringify({search_query : searched_value})
	xmlhttp.onprogress = (event) => {
		let t = xmlhttp.responseText.split("$");
		i = 0
		let finalOutput = ''
		let temp = ''
		for (i; i< t.length - 1; i++ ){
			data = JSON.parse(t[i])
			{#console.log(data)#}
			let article_det = data["article_details_page_url"];
			let article_detail_url = `articles/detail?blog_url=${article_det}`
			temp += `<h1>${data['creator_name']}</h1><br>
				<img src="${data['creator_image_url']}">

				<img height="500" width="500" src=${data['article_image_url']}>
				`
			temp += `<a href="${article_detail_url}"><h1>${data['article_title']}</h1></a> <ul>`


			let tag_list = data["tags_list"]
			tag_list.forEach(tag => {
				temp += `<li>${tag}</li>`
			})
			temp += "</ul>"
			finalOutput = temp;
			document.getElementById("article-div").innerHTML = finalOutput;

		}
	}
        xmlhttp.open("POST", url);
		xmlhttp.setRequestHeader('Content-Type', 'application/json;', 'X-CSRFToken', csrftoken);
        xmlhttp.send(sendData);

		function getQuery() {
			let query = document.getElementById("search_query").value;
			console.log(query);
			return query
		}
	})




</script>
